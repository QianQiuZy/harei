# 重构文档

本文档用于指导整体重构，强调工程化、可落地、可迁移。除本文件与 `blivedm` 目录外，其余历史代码可全部重写。

## 1. 总体目标与约束

- **整体重写**：保留此文件与 `blivedm` 目录，其余代码允许全部推翻重写。
- **前后端分离**：前端 React + 后端 Flask。
- **Docker 化**：单一 Docker 文件同时启动前后端并暴露端口，**不需要 Nginx**（由外部处理）。
- **环境管理**：`.env` 统一管理配置。
- **CI/CD**：使用 GitHub Actions 处理 Docker 构建与发行。
- **数据库**：仍使用 MySQL。
- **包管理**：前端使用 `pnpm`。

## 2. 项目结构建议（仅用于说明，不强制）

> 仅供落地时参考，保持工程清晰。

- `server/`：后端服务
- `web/`：前端项目
- `uploads/`：用户上传文件（**独立于主目录**）
- `assets/`
  - `images/`：业务图片（预留）
  - `backgrounds/`：背景图（预留）

> **注意**：`assets/images/` 与 `assets/backgrounds/` 为图片迁移的目标目录，文件名需保持不变。

## 3. 前端要求

- **功能保持**：原有基本功能不变。
- **布局调整**：原先在电脑端横向占满的所有框架调整为 **2/3 宽度**。
- **提问箱体验**：显示更友好，支持独立展示卡片（blank），点击后浏览器全屏显示，右上角退出。
  - 视觉参考：<https://ask.vjoi.cn/>
  - 源码参考：<https://github.com/Xinrea/JoiAsk>
- **管理界面调整**：
  - `/audit` 移除，统一通过 `/message` 查看。
  - 删除操作改为 **数据库状态标记**，不物理删除行。
  - 管理端使用 **Token 管理**（Redis 记录 Token）。
  - 新增 **舰长管理** 与 **电子礼物管理**，移除 `/addmusic`。
  - 管理主界面集成：Tag 处理、舰长概览、当前提问箱稿件数量等。
- **提问箱功能**：
  - 增加历史提问箱页面，按时间 **由旧到新** 展示。
  - 支持 Tag 过滤（历史所有 Tag）。
  - 图片先返回缩略图，点击后再加载原图。
- **背景图**：非管理界面支持 **多张背景图**，每 5 秒切换，**渐入渐出**。
- **移动端适配**：针对移动端优化宽度与交互。

## 4. 后端要求

- **图片处理**：
  - 所有图片先转为 `.jpg`，质量 80%。
  - 再生成缩略图用于列表快速加载。
  - 若原图为 PNG 且含透明层，透明区域填充为白色。
- **数据库结构调整**：
  - `message` 字段调整为：`message_id`, `message_text`, `tag`, `status`, `created_at`, `IP`。
  - 删除 `guest_id` 字段，新增 `IP` 字段。
- **音乐数据访问优化**：
  - 启动时加载到内存。
  - 每日仅刷新一次数据库缓存，降低访问频率。
- **直播间连接**：
  - 使用 <https://github.com/xfgryujk/blivedm>。
  - 使用身份码连接。
  - 直播状态（开始/结束）由此同步。
- **舰长管理**：
  - 通过身份码获取上舰事件并写入数据库（按月保存）。
  - 可按月导出 `xlsx`。
- **静态资源 TTL**：30 天。
- **原有 API**：必须完整实现。
- **数据迁移**：
  - 原有数据已导出为 `.sql` 文件。
  - 原有图片在主目录 `pic.zip`。
  - 需要输出完整的数据迁移说明文档（含历史数据继承策略）。

## 5. 图片与背景图迁移方案

### 5.1 迁移目标

- 所有原有网络图片（示例：`https://qianqiuzy-1313476938.cos.ap-shanghai.myqcloud.com/...`）需迁移至本地。
- **文件名保持不变**。
- 迁移后引用本地静态资源路径。

### 5.2 目标目录

- 业务图片：`assets/images/`
- 背景图片：`assets/backgrounds/`

> 两个目录需要预留（如不存在请创建），后续所有本地图片统一放置其中。

### 5.3 一次性迁移脚本（示例）

> 说明：将所有网络图片链接保存到 `image_urls.txt`（每行一个 URL），脚本会下载到本地，**文件名保持不变**。

```bash
#!/usr/bin/env bash
set -euo pipefail

URL_LIST="image_urls.txt"
IMAGE_DIR="assets/images"
BG_DIR="assets/backgrounds"

mkdir -p "$IMAGE_DIR" "$BG_DIR"

# 默认下载到 images，如需背景图可在 URL 列表中加前缀标识并在此处扩展逻辑
while IFS= read -r url; do
  [ -z "$url" ] && continue
  filename="${url##*/}"
  curl -fsSL "$url" -o "$IMAGE_DIR/$filename"
  echo "Downloaded: $filename"
done < "$URL_LIST"
```

> 若需要区分背景图与业务图，可在 `image_urls.txt` 使用前缀（如 `bg|<url>`），并在脚本中按前缀分发到不同目录。

## 6. 备注

- 本文档为唯一重构依据，后续如有细化需求请追加到此文档。
- 若发现历史遗留图片遗漏，请补充到迁移清单中，统一迁移到本地。
