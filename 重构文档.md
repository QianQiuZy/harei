# 重构文档

## 1. 目标与范围
- **目标**：在保持现有核心业务能力的基础上完成前后端重构与架构升级，提高可维护性、可扩展性与移动端体验。
- **范围**：
  - 前端：React 全面重构，保证现有功能覆盖与交互优化。
  - 后端：Django 全面重构，保留数据迁移并提升接口与管理能力。
  - 部署：Docker + Nginx + GitHub Actions + .env 环境管理。
- **不在本阶段范围**：
  - 新业务功能的大规模扩展（仅在现有功能内优化）。

## 2. 总体架构与部署
- 现有代码可全部替换，以“重新实现功能”为目标完成重构。
- 前后端分离：
  - 前端域名：`https://harei.cn`
  - 后端接口：由 Nginx 反向代理
- 数据库：MySQL 保持不变。
- 交付方式：Docker 容器化，GitHub Actions 自动构建与发布。
- 环境管理：使用 `.env` 管理敏感配置。

## 3. 前端需求（React）
- 保持原有基本功能不变。
- 提问箱体验优化：
  - 更友好的反馈与显示。
  - 每条留言使用独立卡片（blank）2/3 宽度展示。
  - 点击卡片可全屏浏览，右上角退出。
  - 交互参考：`https://ask.vjoi.cn/`（源代码：`https://github.com/Xinrea/JoiAsk`）。
- 版式调整：
  - 桌面端原有“横向占满”的框架统一调整为 **2/3 宽度**。
- 路由与功能调整：
  - 移除 `/audit`，使用 `/message` 查看。
  - 删除改为数据库“状态标记删除”，禁止直接删除行。
  - `/box` 提交需附带原始 IP（`X-Real-IP`）。
- 管理与展示：
  - 后台管理迁移为 Django Admin。
  - 新增舰长管理与电子礼物管理界面。
  - 删除 `/addmusic`。
  - 管理主界面需要聚合：tag 处理、舰长情况快速阅览、当前提问箱稿件数量等。
- 直播相关：
  - 口水黄豆使用身份码连接直播间（不再使用 cookies）。
  - 直播状态从该连接获取直播开始/结束事件并同步。
  - 舰长管理：使用身份码连接获取上舰事件，按月保存并可下载 xlsx。
- 静态资源：
  - 原腾讯云对象存储改为本地静态文件访问。
  - 非管理界面背景图改为多图轮播，**每 5 秒切换**，支持渐入渐出效果。
- 历史与检索：
  - 增加历史提问箱，按旧到新展示。
  - 支持 tag 检索（使用历史全量 tag）。
- 图片策略：
  - 前端优先展示缩略图，点击卡片后加载原图。
- 移动端：
  - 明确保证移动端友好（**高优先级**）。

## 4. 后端需求（Django）
- 图片处理：
  - 所有图片统一转为 `.jpg`（80% 质量）。
  - 生成缩略图用于快速展示。
  - PNG 透明通道默认转为白底。
- 数据结构调整：
  - `message`：字段调整为 `message_id, message_text, tag, status, created_at, IP`。
  - 移除 `guest_id`，新增 `IP`。
- music 处理：
  - 启动时加载内存。
  - 每日定时读取数据库并缓存（尽量低频访问）。
- 直播间连接：
  - 可独立运行服务（允许非 Django 架构）。
  - 使用 `https://github.com/xfgryujk/blivedm`（目前已放置在主文件夹中），以身份码连接。
- 静态资源与上传：
  - 静态文件 TTL 设置为 30 天。
  - `uploads` 目录独立处理，不放在主目录中。
- 数据迁移：
  - 必须提供完整迁移文档，确保历史数据继承。

## 5. 交付与验收建议（补充）
- **交付物**：
  - 前端、后端完整代码与部署配置（Docker + Nginx + Actions）。
  - 数据库迁移与回滚方案文档。
  - 直播连接服务的独立运行说明。
- **验收要点**：
  - 现有功能可用性与一致性。
  - 移动端体验通过主流设备自测。
  - 图片缩略图/原图切换可用。
  - 后台管理功能齐全且权限清晰。

## 6. 风险与注意事项（补充）
- 直播间连接稳定性与身份码安全需重点验证。
- 数据库迁移需保证可回滚。
- 静态资源迁移后需确认缓存与访问路径正确。
