# 数据迁移说明

## 目标

- 保留历史数据库数据与图片资源。
- 图片统一落地到 `assets/images/` 与 `assets/backgrounds/`，文件名保持不变。
- 历史数据字段按新结构映射，并提供可追溯策略。

## 迁移准备

1. 历史 SQL：`data/*.sql`（由原系统导出）。
2. 历史图片归档：`pic.zip`（位于仓库根目录）。
3. 新系统已创建的数据库结构见 `server/models/`。

## 数据库字段映射

| 旧字段 | 新字段 | 说明 |
| --- | --- | --- |
| id | message_id | 主键保持一致或重新生成，推荐保留原 id | 
| message | message_text | 字段更名 |
| tag | tag | 保持不变 |
| status | status | 状态改为字符串（pending/approved/rejected/deleted） |
| created_at | created_at | 保持时间顺序 |
| guest_id | - | 已移除 |
| IP | ip | 新增，迁移时可留空或使用历史日志补全 |

> 迁移时请确保所有记录默认状态为 `approved` 或按历史审核状态映射。

## 迁移步骤

### 1. 初始化数据库

```bash
mysql -h <host> -u <user> -p -e "CREATE DATABASE harei DEFAULT CHARACTER SET utf8mb4;"
```

### 2. 导入历史数据

```bash
mysql -h <host> -u <user> -p harei < data/your_export.sql
```

### 3. 字段调整与清洗

```sql
ALTER TABLE messages
  CHANGE COLUMN id message_id INT PRIMARY KEY AUTO_INCREMENT,
  CHANGE COLUMN message message_text TEXT NOT NULL,
  ADD COLUMN ip VARCHAR(64) NULL,
  MODIFY COLUMN status VARCHAR(32) NOT NULL DEFAULT 'approved';
```

> 若历史表名不同，请先通过 `RENAME TABLE` 调整为 `messages`。

### 4. 图片迁移

```bash
unzip pic.zip -d assets/images
```

如需区分背景图，将背景图移动至 `assets/backgrounds/`，并保持文件名不变。

### 5. 缩略图重建

使用后端工具批量生成缩略图（可通过上传接口或编写脚本复用 `server/utils/images.py`），确保每张原图对应 `uploads/thumbs/` 中的缩略图。

## 历史数据继承策略

- **消息内容**：保留原始文本，Tag 原样继承。
- **审核状态**：历史已发布消息统一标记为 `approved`；历史删除或隐藏内容标记为 `deleted`。
- **图片引用**：字段中若保存 URL，需替换为 `/assets/images/<filename>` 或 `/assets/backgrounds/<filename>`。
- **IP 字段**：可留空，或通过历史日志补写。

## 验证清单

- 数据库表字段与 `server/models/` 保持一致。
- `/api/messages/history` 可按时间顺序返回历史数据。
- 页面列表优先加载缩略图，点击后加载原图。
